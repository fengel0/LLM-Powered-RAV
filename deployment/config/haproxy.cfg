global
  maxconn 4096

defaults
  mode http
  timeout connect 5s
  timeout client  2h
  timeout server  2h

frontend fe_ollama
  bind *:8080
  default_backend be_ollama

backend be_ollama
  balance leastconn              # <= choose the least busy across ALL servers
  option http-server-close
  option httpclose
  option httpchk GET /
  http-check expect status 200
  
  # Set Host header only when connecting to the HTTPS server (port 443)
  acl is_ssl_port dst_port 443
  http-request set-header Host deepresearch-mokitul.ai.fh-erfurt.de 
  
  # fastest single host (HTTPS) - will get the custom Host header
  #server mokitul deepresearch-mokitul.ai.fh-erfurt.de:443 ssl verify none maxconn 4 weight 1
  # fast (IPs 3,4,5) — let each take 3 concurrent requests - keep original Host
  server n3 192.168.83.3:11434  check maxconn 4 weight 1
  server n4 192.168.83.4:11434  check maxconn 4 weight 1
  server n5 192.168.83.5:11434  check maxconn 4 weight 1
  #server n6 192.168.83.6:11434  check maxconn 4 weight 1
  # medium (18,19,20) — smaller per-node cap - keep original Host
  server n17 192.168.83.17:11434 check maxconn 4 weight 1
  #server n245 192.168.83.245:11434 check maxconn 4 weight 1
  #server n19 192.168.83.19:11434 check maxconn 4 weight 1
  #server n20 192.168.83.20:11434 check maxconn 4 weight 1
  # slowest (17) — let it take at most one at a time - keep original Host
  #server n17 192.168.83.17:11434 check maxconn 1 weight 1
